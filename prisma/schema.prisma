generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  name      String
  role      String
  pin       String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id        String    @id @default(uuid())
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  menus     Menu[]
}

// Menu (base item, NO PRICE)
model Menu {
  id          String          @id @default(uuid())
  name        String
  localName   String?         // Lao name support
  description String?
  isAvailable Boolean         @default(true)
  image       String?         @default("/placeholder.svg")
  categoryId  String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  category    Category        @relation(fields: [categoryId], references: [id])
  variations  MenuVariation[]
  recipes     Recipe[]
}

// Variation (HOT/COLD/FRAPPE, NO PRICE)
model MenuVariation {
  id        String          @id @default(uuid())
  menuId    String
  type      String          // HOT, COLD, FRAPPE
  isEnabled Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  menu      Menu            @relation(fields: [menuId], references: [id], onDelete: Cascade)
  sizes     VariationSize[]
  displayOrder Int          @default(0)

  @@unique([menuId, type])
}

// Size (S/M/L with PRICE - only place price is stored)
model VariationSize {
  id          String        @id @default(uuid())
  variationId String
  size        String        // S, M, L
  price       Float         // PRICE STORED HERE
  isAvailable Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  variation   MenuVariation @relation(fields: [variationId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]
  displayOrder Int          @default(0)

  @@unique([variationId, size])
}

model Ingredient {
  id           String   @id @default(uuid())
  name         String
  unit         String
  mainStock    Float    @default(0) // Warehouse
  subStock     Float    @default(0) // Shop/Store (POS deducts from here)
  minStock     Float    // Warehouse Min
  maxStock     Float    // Warehouse Max
  minStockSub  Float    @default(0) // Shop Min
  maxStockSub  Float    @default(0) // Shop Max
  cost         Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  recipes      Recipe[]
  transactions StockTransaction[]
  stockCounts  StockCount[]
}

model StockCount {
  id               String     @id @default(uuid())
  ingredientId     String
  theoreticalStock Float
  actualStock      Float
  difference       Float
  notes            String?
  userId           String?
  createdAt        DateTime   @default(now())
  ingredient       Ingredient @relation(fields: [ingredientId], references: [id])
}

model StockTransaction {
  id           String     @id @default(uuid())
  ingredientId String
  type         String     // TRANSFER, DEPOSIT, WITHDRAW, SHOP_ADJUST, USAGE
  quantity     Float
  fromStore    String?    // MAIN, SUB
  toStore      String?    // MAIN, SUB
  notes        String?
  reason       String?    // For WITHDRAW and SHOP_ADJUST
  cost         Float?     // For DEPOSIT to track purchase cost
  userId       String?
  createdAt    DateTime   @default(now())
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
}

model Recipe {
  id           String     @id @default(uuid())
  menuId       String
  ingredientId String
  quantity     Float
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  menu         Menu       @relation(fields: [menuId], references: [id])

  @@unique([menuId, ingredientId])
}

model Customer {
  id            String    @id @default(uuid())
  name          String
  phone         String?
  email         String?
  dateOfBirth   DateTime?
  loyaltyPoints Int       @default(0)
  totalSpent    Float     @default(0)
  visitCount    Int       @default(0)
  lastVisit     DateTime  @default(now())
  type          String    @default("NORMAL") // NORMAL, COMPLIMENTARY
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  orders        Order[]
}

model Promotion {
  id            String   @id @default(uuid())
  name          String
  description   String?
  code          String   @unique
  discountType  String
  discountValue Float
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  orders        Order[]
}

model Order {
  id                 String      @id @default(uuid())
  orderNumber        String
  status             String      @default("COMPLETED")
  total              Float
  subtotal           Float
  tax                Float
  discount           Float       @default(0)
  promoId            String?
  paymentMethod      String      @default("CASH")
  customerId         String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  cancellationReason String?
  beeperNumber       String?
  pointsRedeemed     Int?        @default(0)
  taxAmount          Float?      @default(0)
  isReportable       Boolean     @default(true)
  customer           Customer?   @relation(fields: [customerId], references: [id])
  promotion          Promotion?  @relation(fields: [promoId], references: [id])
  items              OrderItem[]
}

model Setting {
  key   String @id
  value String
}

model Shift {
  id                String    @id @default(uuid())
  userId            String?
  startTime         DateTime  @default(now())
  endTime           DateTime?
  startCash         Float     @default(0)
  endCash           Float?
  actualCash        Float?
  difference        Float?
  cashPayments      Float     @default(0)
  status            String    @default("OPEN")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  responsiblePerson String?
}

// OrderItem now references VariationSize (single source of truth)
model OrderItem {
  id              String         @id @default(uuid())
  orderId         String
  variationSizeId String         // FK to VariationSize (required)
  name            String         // Snapshot: "Cocoa (Hot) - M"
  price           Float          // Snapshot from VariationSize at order time
  quantity        Int
  total           Float
  
  // Customizations (sugar/shot remain separate from pricing)
  sugarLevel String?
  shotType   String?
  cupSize    String?

  variationSize VariationSize @relation(fields: [variationSizeId], references: [id])
  order         Order         @relation(fields: [orderId], references: [id])
}

model StockCount {
  id               String     @id @default(uuid())
  ingredientId     String
  theoreticalStock Float
  actualStock      Float
  difference       Float
  notes            String?
  createdAt        DateTime   @default(now())
  ingredient       Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
}
